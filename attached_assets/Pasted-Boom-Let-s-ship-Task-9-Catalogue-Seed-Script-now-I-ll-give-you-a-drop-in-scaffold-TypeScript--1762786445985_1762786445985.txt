Boom. Let’s ship Task 9 — Catalogue Seed Script now. I’ll give you a drop-in scaffold (TypeScript + SQL) that matches the Hybrid split, writes WebP, saves metadata (orientation, safeArea, focalPoints, sidefillPalette, CLIP embedding), and is provider-agnostic (swap SD/DALL·E later).

⸻

1) Quick SQL migration (artworks)

-- 01_artworks.sql
CREATE TYPE artwork_tier AS ENUM ('dual','square','landscape');
CREATE TYPE artwork_orientation AS ENUM ('portrait','landscape','square');

CREATE TABLE artworks (
  id UUID PRIMARY KEY,
  is_library BOOLEAN NOT NULL DEFAULT TRUE,
  tier artwork_tier NOT NULL,
  orientation artwork_orientation NOT NULL,
  aspect_ratio TEXT NOT NULL,       -- '16:9' | '9:16' | '1:1'
  width INT NOT NULL,
  height INT NOT NULL,
  genre TEXT NOT NULL,
  mood TEXT NOT NULL,
  style_tags TEXT[] NOT NULL,       -- ['vaporwave','neon',...]
  storage_path TEXT NOT NULL,       -- /library/{...}.webp
  safe_area JSONB,                  -- {x,y,w,h}
  focal_points JSONB,               -- [{x,y,r}]
  sidefill_palette TEXT[],          -- hex colors
  clip_embedding VECTOR(768),       -- or JSONB if you prefer
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE INDEX idx_artworks_orientation ON artworks(orientation);
CREATE INDEX idx_artworks_created_at ON artworks(created_at);
CREATE INDEX idx_artworks_style_gin ON artworks USING GIN (style_tags);


⸻

2) Project layout

/scripts/catalogue-seed.ts
/src/config.ts
/src/providers/stableDiffusion.ts
/src/services/saliency.ts
/src/services/palette.ts
/src/services/clip.ts
/src/services/storage.ts
/src/prompts.ts


⸻

3) env (.env)

CATALOGUE_BUCKET=algorhythmic-library
CDN_BASE=https://cdn.example.com
SD_API_TOKEN=...
OPENAI_API_KEY=...         # if you use OpenAI embeddings


⸻

4) Prompt suffixes (orientation-aware)

// src/prompts.ts
export const SUFFIX = {
  landscape: "wide cinematic framing, panoramic vista, rule of thirds, 16:9 aspect ratio",
  portrait:  "vertical framing, subject centered in upper third, tall perspective, 9:16 aspect ratio",
  square:    "central composition, balanced margins, safe subject inside middle 60%, 1:1 aspect ratio",
};


⸻

5) Seed config (hybrid split)

// src/config.ts
export const GENRES = ["lofi","ambient","jazz","rock","hiphop","classical","edm","pop","world","experimental"] as const;
export const MOODS  = ["calm","melancholic","dreamy","energetic","dark","reflective","playful","aggressive","uplifting","mysterious"] as const;
export const STYLES = ["vaporwave","cyberpunk","synthwave","psychedelic","space-opera","fractal","minimal","geometric","impressionism","pointillism","abstract-expressionism","watercolor","glitch"] as const;

export const TARGET = {
  artworks: 1000,        // unique concepts
  split: { dual: 0.40, square: 0.45, landscape: 0.15 },
  sizes: {
    landscape: { w: 1920, h: 1080, aspect: "16:9" },
    portrait:  { w: 1080, h: 1920, aspect: "9:16"  },
    square:    { w: 1536, h: 1536, aspect: "1:1"   },
  }
};


⸻

6) Stable Diffusion provider (pluggable)

// src/providers/stableDiffusion.ts
import fetch from "node-fetch";

export type SDInput = {
  prompt: string;
  width: number;
  height: number;
};

export async function generateImageSD(input: SDInput): Promise<Buffer> {
  // Example placeholder – integrate Replicate/Auto1111/etc.
  // Return raw PNG/WebP bytes.
  const { prompt, width, height } = input;
  // TODO: implement actual API call. For now, throw if not configured.
  if (!process.env.SD_API_TOKEN) throw new Error("SD_API_TOKEN missing");
  // ... call provider ...
  // return Buffer.from(binary);
  throw new Error("Stable Diffusion provider not wired yet");
}


⸻

7) Saliency + palette + CLIP

// src/services/saliency.ts
// Lightweight heuristic + placeholder; swap with OpenCV/TFLite later.
import sharp from "sharp";
export type SafeArea = { x:number; y:number; w:number; h:number };
export type Focal = { x:number; y:number; r:number };

export async function computeSaliency(img: Buffer, w: number, h: number): Promise<{safeArea: SafeArea; focal: Focal[]; confidence: number}> {
  // Heuristic: center-biased safe area; upgrade later with real saliency.
  const safe: SafeArea = { x:0.1, y:0.1, w:0.8, h:0.8 };
  const focal: Focal[] = [{ x:0.5, y:0.4, r:0.2 }];
  return { safeArea: safe, focal, confidence: 0.7 };
}

// src/services/palette.ts
import Vibrant from "node-vibrant";
export async function extractPalette(img: Buffer): Promise<string[]> {
  const palette = await Vibrant.from(img).getPalette();
  const colors = Object.values(palette).filter(Boolean).map(c => c!.getHex());
  return colors.slice(0,5);
}

// src/services/clip.ts
// Choose one: OpenAI embeddings or local model. Here’s OpenAI as a drop-in.
import OpenAI from "openai";
const client = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

export async function embedText(text: string): Promise<number[]> {
  // Use text-embedding-3-small (cheap) or CLIP if you have it.
  const res = await client.embeddings.create({ model: "text-embedding-3-small", input: text });
  return res.data[0].embedding;
}


⸻

8) Storage helper

// src/services/storage.ts
import { createHash } from "crypto";
import sharp from "sharp";
import { extname } from "path";
import { S3Client, PutObjectCommand } from "@aws-sdk/client-s3";

const s3 = new S3Client({});

export async function saveWebP(path: string, pngOrWebP: Buffer): Promise<string> {
  const webp = await sharp(pngOrWebP).webp({ quality: 95, lossless: true }).toBuffer();
  await s3.send(new PutObjectCommand({
    Bucket: process.env.CATALOGUE_BUCKET!,
    Key: path.replace(/^\//, ""),
    Body: webp,
    ContentType: "image/webp",
    CacheControl: "public, max-age=31536000, immutable",
  }));
  return `${process.env.CDN_BASE}${path}`;
}


⸻

9) The seed script

// scripts/catalogue-seed.ts
import { TARGET, GENRES, MOODS, STYLES } from "../src/config";
import { SUFFIX } from "../src/prompts";
import { generateImageSD } from "../src/providers/stableDiffusion";
import { computeSaliency } from "../src/services/saliency";
import { extractPalette } from "../src/services/palette";
import { embedText } from "../src/services/clip";
import { saveWebP } from "../src/services/storage";
import { randomUUID } from "crypto";
import pg from "pg";

type Tier = "dual" | "square" | "landscape";
type Ori  = "landscape" | "portrait" | "square";

const pool = new pg.Pool({ connectionString: process.env.DATABASE_URL });

function pick<T>(arr: readonly T[]) { return arr[Math.floor(Math.random()*arr.length)]; }

function buildPrompt(genre:string, mood:string, style:string, orientation:Ori) {
  return `${style} ${genre} visual, ${mood} atmosphere, richly textured, ${SUFFIX[orientation]}`;
}

function targetCounts() {
  const { artworks, split } = TARGET;
  const dualArtworks = Math.round(artworks * split.dual);         // 400 artworks → 800 files
  const squareFiles  = Math.round(artworks * split.square);       // 450 files
  const landFiles    = Math.round(artworks * split.landscape);    // 150 files
  return { dualArtworks, squareFiles, landFiles };
}

async function insertArtwork(row: any) {
  const q = `
    INSERT INTO artworks
      (id,is_library,tier,orientation,aspect_ratio,width,height,genre,mood,style_tags,storage_path,safe_area,focal_points,sidefill_palette,clip_embedding)
    VALUES
      ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15)
  `;
  await pool.query(q, [
    row.id, true, row.tier, row.orientation, row.aspect_ratio, row.width, row.height,
    row.genre, row.mood, row.style_tags, row.storage_path,
    row.safe_area, row.focal_points, row.sidefill_palette, row.clip_embedding
  ]);
}

async function makeOne(genre:string, mood:string, style:string, orientation:Ori, tier:Tier) {
  const size = orientation === "landscape" ? TARGET.sizes.landscape
            : orientation === "portrait"  ? TARGET.sizes.portrait
            : TARGET.sizes.square;

  const prompt = buildPrompt(genre, mood, style, orientation);
  const raw = await generateImageSD({ prompt, width: size.w, height: size.h });

  const id = randomUUID();
  const path = `/library/${orientation}/${genre}/${mood}/${style}/${id}.webp`;

  const { safeArea, focal } = await computeSaliency(raw, size.w, size.h);
  const palette = await extractPalette(raw);
  const embedding = await embedText(`${genre} ${mood} ${style} ${orientation}`);

  await saveWebP(path, raw);

  await insertArtwork({
    id,
    tier,
    orientation,
    aspect_ratio: size.aspect,
    width: size.w, height: size.h,
    genre, mood,
    style_tags: [style],
    storage_path: path,
    safe_area: safeArea,
    focal_points: focal,
    sidefill_palette: palette,
    clip_embedding: embedding
  });
}

async function run() {
  const { dualArtworks, squareFiles, landFiles } = targetCounts();

  // A) Dual-native: generate BOTH orientations for each unique concept
  for (let i=0; i<dualArtworks; i++) {
    const g = pick(GENRES), m = pick(MOODS), s = pick(STYLES);
    await makeOne(g,m,s,"landscape","dual");
    await makeOne(g,m,s,"portrait","dual");
  }

  // B) Square-master: single square files
  for (let i=0; i<squareFiles; i++) {
    const g = pick(GENRES), m = pick(MOODS), s = pick(STYLES);
    await makeOne(g,m,s,"square","square");
  }

  // C) Landscape-only: single landscape files
  for (let i=0; i<landFiles; i++) {
    const g = pick(GENRES), m = pick(MOODS), s = pick(STYLES);
    await makeOne(g,m,s,"landscape","landscape");
  }

  console.log("✅ Seed complete.");
  process.exit(0);
}

run().catch(e => { console.error(e); process.exit(1); });

Run:

npm run catalogue:seed -- --count=1000 --tiers=hybrid

(Flags are parsed inside config or add yargs if you want true CLI options.)

⸻

10) What’s left to wire (tiny TODOs)
	•	Implement the actual Stable Diffusion API call in providers/stableDiffusion.ts.
	•	If you’re not ready to store embeddings as VECTOR, store as JSONB now; migrate later.
	•	Swap computeSaliency with your OpenCV/TFLite integration when you’re ready (same return type).

⸻

What do you want next?
	•	I can provide a drop-in Stable Diffusion (Replicate) provider implementation, or
	•	The client crop + side-fill renderer (React helper with sharp shader math).

Say the word and I’ll paste the exact module you prefer.